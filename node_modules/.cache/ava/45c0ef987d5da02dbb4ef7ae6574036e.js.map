{"version":3,"sources":["agent-tests.js"],"names":["test","require","sinon","proxyquire","agentFixtures","config","logging","MetricStub","belongsTo","spy","id","uuid","AgentStub","db","sandbox","single","Object","assign","connectedArgs","where","connected","usernameArgs","username","uuidArgs","newAgent","name","hostname","pid","newAgentUuidArgs","beforeEach","findOne","stub","withArgs","returns","Promise","resolve","findByUuid","createSandbox","hasMany","create","toJSON","update","findById","byId","byUuid","findAll","all","iot","setupDatabase","afterEach","restore","t","truthy","Agent","serial","true","called","calledWith","agent","calledOnce","deepEqual","agents","is","length","findConnected","findByUsername","createOrUpdate","calledTwice"],"mappings":"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","file":"agent-tests.js","sourcesContent":["'use-strict'\r\n\r\nconst test = require('ava')\r\nconst sinon = require('sinon')\r\nconst proxyquire = require('proxyquire')\r\nconst agentFixtures = require('./fixtures/agent')\r\n// ----------------------------------------------------------\r\nlet config = {\r\n  logging () {}\r\n}\r\n// ----------------------------------------------------\r\n\r\nlet MetricStub = {\r\n  belongsTo: sinon.spy()// un spy es un funcion que nos dice datos sobre la funcion, es un chicmoso vamos\r\n}\r\n// -------------------------------------------------------------\r\n\r\nlet id = 1\r\nlet uuid = 'yyy-yyy-yyy'\r\nlet AgentStub = null\r\nlet db = null\r\nlet sandbox = null\r\n\r\n// ----------------------------------------------\r\nlet single = Object.assign({}, agentFixtures.single)\r\n// -----------------------------------------------------------------\r\nlet connectedArgs = {\r\n  where: { connected: true }\r\n}\r\n//------------------------------------------------------------\r\n\r\nlet usernameArgs = {\r\n  where: { username: 'iot', connected: true }\r\n}\r\n// ------------------------------------------------------------\r\nlet uuidArgs = {\r\n  where: { uuid }\r\n}\r\n// -------------------------------------------------------------\r\nlet newAgent = {\r\n  uuid: '123-123-123',\r\n  name: 'test',\r\n  username: 'test',\r\n  hostname: 'test',\r\n  pid: 0,\r\n  connected: false \r\n}\r\n\r\nlet newAgentUuidArgs = {\r\n  where: {\r\n    uuid: newAgent.uuid\r\n  }\r\n}\r\ntest.beforeEach(async () => {\r\n  AgentStub.findOne = sandbox.stub()\r\n  AgentStub.findOne.withArgs(uuidArgs).returns(Promise.resolve(agentFixtures.findByUuid(uuid)))\r\n  AgentStub.findOne.withArgs(newAgentUuidArgs).returns(Promise.resolve(agentFixtures.findByUuid(newAgent.uuid)))\r\n})\r\n\r\n/* let uuidArgs = {\r\n  where: {\r\n    uuid\r\n  }\r\n} */\r\n\r\ntest.beforeEach(async () => {\r\n  sandbox = sinon.createSandbox()\r\n\r\n  AgentStub = {\r\n    // un sandbox es un ambiente especifico que solo funciona para este caso en particular\r\n    hasMany: sandbox.spy()\r\n  }\r\n\r\n  // Model create Stub\r\n  AgentStub.create = sandbox.stub()\r\n  AgentStub.create.withArgs(newAgent).returns(Promise.resolve({\r\n    toJSON () { return newAgent }\r\n  }))\r\n\r\n  // Model update Stub\r\n  AgentStub.update = sandbox.stub()\r\n  AgentStub.update.withArgs(single, uuidArgs).returns(Promise.resolve(single))\r\n\r\n  // Modelo findById Stub\r\n  AgentStub.findById = sandbox.stub()\r\n  AgentStub.findById.withArgs(id).returns(Promise.resolve(agentFixtures.byId(id)))\r\n\r\n  // Model findOne Stub\r\n  AgentStub.findOne = sandbox.stub()\r\n  AgentStub.findOne.withArgs(uuidArgs).returns(Promise.resolve(agentFixtures.byUuid(uuid)))\r\n\r\n  // Model findAll Stub\r\n  AgentStub.findAll = sandbox.stub()\r\n  AgentStub.findAll.withArgs().returns(Promise.resolve(agentFixtures.all))\r\n  AgentStub.findAll.withArgs(connectedArgs).returns(Promise.resolve(agentFixtures.connected))\r\n  AgentStub.findAll.withArgs(usernameArgs).returns(Promise.resolve(agentFixtures.iot))\r\n\r\n  const setupDatabase = proxyquire('../', {\r\n    './models/agent': () => AgentStub, // las mismas rutas que las que estan e declaradas en index.js\r\n    './models/metric': () => MetricStub\r\n  })\r\n\r\n  db = await setupDatabase(config)\r\n})\r\n\r\ntest.afterEach(() => {\r\n  sandbox && sandbox.restore()\r\n})\r\n\r\ntest('Agent', t => { // verificacion de que Agent exista\r\n  t.truthy(db.Agent, 'Agent service should exist') // si se resulve el valor a verdadero\r\n})\r\n\r\n// ----------------------------------------------------------------\r\ntest.serial('Setup', t => {\r\n  t.true(AgentStub.hasMany.called, 'AgentModel.hasMany fue ejecutada')\r\n  t.true(AgentStub.hasMany.calledWith(MetricStub), 'Argumento de esa funcion')\r\n  t.true(MetricStub.belongsTo.called, 'MetricModel.belongsTo fue ejecutada')\r\n  t.true(MetricStub.belongsTo.calledWith(AgentStub), 'Argumentos de esa funcion')\r\n})\r\n// --------------------------------------------------------------------------\r\ntest.serial('Agent#findById', async t => {\r\n  let agent = await db.Agent.findById(id)\r\n\r\n  t.true(AgentStub.findById.called, 'findById debera llamar al modelo')\r\n  t.true(AgentStub.findById.calledOnce, 'findById debera ser llamada una vez')\r\n  t.true(AgentStub.findById.calledWith(id), 'findById debera llamar con los argumentos que son')\r\n\r\n  t.deepEqual(agent, agentFixtures.byId(id), 'deberia ser el mismo')\r\n})\r\n// -----------------------------------------------------------------------\r\ntest.serial('Agent#findByUuid', async t => {\r\n  let agent = await db.Agent.findByUuid(uuid)\r\n\r\n  t.true(AgentStub.findOne.called, 'findOne solo llamara al modelo')\r\n  t.true(AgentStub.findOne.calledOnce, 'findOne debera llamarse una sola vez')\r\n  t.true(AgentStub.findOne.calledWith(uuidArgs), 'findOne debera llamar con argumentos')\r\n\r\n  t.deepEqual(agent, agentFixtures.byUuid(uuid), 'agent debera ser el mismo')\r\n})\r\n// ------------------------------------------------------------------------------\r\ntest.serial('Agent#findAll', async t => {\r\n  let agents = await db.Agent.findAll()\r\n\r\n  t.true(AgentStub.findAll.called, 'findAll debera ser llamado')\r\n  t.true(AgentStub.findAll.calledOnce, 'findAll debera ser llamado una sola vez')\r\n  t.true(AgentStub.findAll.calledWith(), 'findAll debera ser llamado sin argumentos')\r\n\r\n  t.is(agents.length, agentFixtures.all.length, 'agents deberan ser los mismos')\r\n  t.deepEqual(agents, agentFixtures.all, 'agents deberan ser los mismos')\r\n})\r\n// --------------------------------------------------------------------\r\ntest.serial('Agent#findConnected', async t => {\r\n  let agents = await db.Agent.findConnected()\r\n\r\n  t.true(AgentStub.findAll.called, 'findAll debera llamar al modelo')\r\n  t.true(AgentStub.findAll.calledOnce, 'findAll debera ser llamado una sola vez')\r\n  t.true(AgentStub.findAll.calledWith(connectedArgs), 'findAll debera ser llamado con argumentos')\r\n\r\n  t.is(agents.length, agentFixtures.connected.length, 'agents deberanser llamado')\r\n  t.deepEqual(agents, agentFixtures.connected, 'agents debera ser el mismo')\r\n})\r\n// -------------------------------------------------------------\r\n\r\ntest.serial('Agent#findByUsername', async t => {\r\n  let agents = await db.Agent.findByUsername('iot')\r\n\r\n  t.true(AgentStub.findAll.called, 'findAll debera llamar el modelo')\r\n  t.true(AgentStub.findAll.calledOnce, 'findAll debera ser llamado una sola vez')\r\n  t.true(AgentStub.findAll.calledWith(usernameArgs), 'findAll debera ser llamado con argumentos')\r\n\r\n  t.is(agents.length, agentFixtures.iot.length, 'agents deneran ser los mismos')\r\n  t.deepEqual(agents, agentFixtures.iot, 'agents deberan ser los mismos')\r\n})\r\n// ---------------------------------------------------\r\ntest.serial('Agent#createOrUpdate - exists', async t => {\r\n  let agent = await db.Agent.createOrUpdate(single)\r\n\r\n  t.true(AgentStub.findOne.called, 'findOne debera llamar al modelo')\r\n  t.true(AgentStub.findOne.calledTwice, 'findOne debera llamar dos veces')\r\n  t.true(AgentStub.findOne.calledWith(uuidArgs), 'findOne debe ser llamado con argumentos')\r\n  t.true(AgentStub.update.called, 'agent.update llama un modelo')\r\n  t.true(AgentStub.update.calledOnce, 'update debera ser llamado una sola vez')\r\n  t.true(AgentStub.update.calledWith(single), 'agent.update debera ser llamado singularmente')\r\n\r\n  t.deepEqual(agent, single, 'el agent deberia ser el mismo')\r\n})\r\n// ------------------------------------------------------------\r\ntest.serial('Agent#createOrUpdate - new', async t => {\r\n let agent = await db.Agent.createOrUpdate(newAgent)\r\n\r\n  t.true(AgentStub.findOne.called, 'findOne debera llamar una vez al objeto')\r\n  t.true(AgentStub.findOne.calledOnce, 'findOne debera llamar una vez')\r\n  t.true(AgentStub.findOne.calledWith({\r\n    where: { uuid: newAgent.uuid }\r\n  }), 'findOne debera llamar los argumentos de uuid args')\r\n  t.true(AgentStub.create.called, 'create debera llamar un modelo')\r\n  t.true(AgentStub.create.calledOnce, 'create debera llamarse una vez')\r\n  t.true(AgentStub.create.calledWith(newAgent), 'create debera llamarse con argumentos')\r\n\r\n  t.deepEqual(agent.newAgent, 'agent debera llamarse solo')\r\n})\r\n\r\n// ---------------------------------------------------------------------\r\n"]}